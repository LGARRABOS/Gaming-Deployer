---
- name: Provision Minecraft server
  hosts: all
  become: true
  vars:
    # When mc_admin_user is set: install in their home and run as them; else classic /opt/minecraft + user minecraft
    mc_user: "{{ mc_admin_user | default('minecraft') }}"
    mc_dir: "{{ ('/home/' + mc_admin_user + '/minecraft') if mc_admin_user is defined else '/opt/minecraft' }}"
    mc_service_name: minecraft

  tasks:
    - name: Wait for dpkg lock to be released (Cloud-Init / unattended-upgrades)
      when: ansible_os_family == "Debian"
      shell: |
        for i in $(seq 1 90); do
          fuser /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/lib/apt/lists/lock >/dev/null 2>&1 || exit 0
          sleep 2
        done
        exit 1
      register: wait_dpkg
      failed_when: wait_dpkg.rc != 0
      changed_when: false

    - name: Ensure minecraft group exists (only when not using mcadmin)
      group:
        name: minecraft
        state: present
      when: mc_admin_user is not defined

    - name: Ensure APT cache is updated
      apt:
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Wait for dpkg lock before Java install (Cloud-Init / unattended-upgrades)
      when: ansible_os_family == "Debian"
      shell: |
        for i in $(seq 1 90); do
          fuser /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/lib/apt/lists/lock >/dev/null 2>&1 || exit 0
          sleep 2
        done
        exit 1
      register: wait_dpkg_java
      failed_when: wait_dpkg_java.rc != 0
      changed_when: false

    # Minecraft 1.21.x requires Java 21 (class file 65.0). Java 17 (61.0) is too old.
    - name: Install Java 21 runtime
      apt:
        name: openjdk-21-jre-headless
        state: present
      when: ansible_os_family == "Debian"

    - name: Create minecraft user (only when not using mcadmin)
      user:
        name: minecraft
        shell: /bin/bash
        create_home: true
        group: minecraft
      when: mc_admin_user is not defined

    - name: Create SFTP admin user for Minecraft (home only, access restricted to home)
      when:
        - mc_admin_user is defined
        - mc_admin_password is defined
      user:
        name: "{{ mc_admin_user }}"
        shell: /bin/bash
        create_home: true
        home: "/home/{{ mc_admin_user }}"
        password: "{{ mc_admin_password | password_hash('sha512') }}"

    - name: Prepare mcadmin home for SFTP chroot (root must own chroot dir)
      when: mc_admin_user is defined
      file:
        path: "/home/{{ mc_admin_user }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Create Minecraft directory (in mcadmin home or /opt/minecraft)
      file:
        path: "{{ mc_dir }}"
        state: directory
        owner: "{{ mc_user }}"
        group: "{{ mc_user }}"
        mode: "0755"

    - name: Enable SSH password authentication (for SFTP mcadmin access)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication\s+'
        line: 'PasswordAuthentication yes'
      notify: Restart sshd
      when: mc_admin_user is defined

    - name: Enable SSH challenge-response (password) for SFTP clients
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?KbdInteractiveAuthentication\s+'
        line: 'KbdInteractiveAuthentication yes'
      notify: Restart sshd
      when: mc_admin_user is defined

    - name: Restrict SFTP to mcadmin home only (chroot)
      when: mc_admin_user is defined
      blockinfile:
        path: /etc/ssh/sshd_config
        marker: "# {mark} ANSIBLE MANAGED - mcadmin chroot"
        block: |
          Match User {{ mc_admin_user }}
            ChrootDirectory /home/{{ mc_admin_user }}
            ForceCommand internal-sftp
            AllowTcpForwarding no
      notify: Restart sshd

    # Mojang moved server jars to piston-data.mojang.com (launcher.mojang.com returns 404).
    # URL below is vanilla 1.21.11 from https://piston-meta.mojang.com/mc/game/version_manifest_v2.json
    - name: Download Minecraft server jar (vanilla; paper/purpur use vanilla jar for now)
      get_url:
        url: "https://piston-data.mojang.com/v1/objects/64bb6d763bed0a9f1d632ec347938594144943ed/server.jar"
        dest: "{{ mc_dir }}/server.jar"
        mode: "0644"

    - name: Set ownership of server jar
      file:
        path: "{{ mc_dir }}/server.jar"
        owner: "{{ mc_user }}"
        group: "{{ mc_user }}"

    - name: Accept EULA
      copy:
        dest: "{{ mc_dir }}/eula.txt"
        content: "eula={{ 'true' if mc_eula else 'false' }}\n"
        owner: "{{ mc_user }}"
        group: "{{ mc_user }}"
        mode: "0644"

    - name: Render server.properties
      copy:
        dest: "{{ mc_dir }}/server.properties"
        owner: "{{ mc_user }}"
        group: "{{ mc_user }}"
        mode: "0644"
        content: |
          server-port={{ mc_port }}
          motd={{ mc_motd }}
          max-players={{ mc_max_players }}
          online-mode={{ 'true' if mc_online_mode else 'false' }}

    - name: Open firewall ports for Minecraft
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      # mc_extra_ports peut être null/None si l'API ne fournit pas de liste.
      # default([], true) force alors une liste vide pour éviter l'erreur de concaténation.
      loop: "{{ [mc_port] + (mc_extra_ports | default([], true)) }}"
      when: ansible_facts.services is not defined or 'ufw' in ansible_facts.services

    - name: Create systemd service
      copy:
        dest: /etc/systemd/system/{{ mc_service_name }}.service
        mode: "0644"
        content: |
          [Unit]
          Description=Minecraft Server
          After=network.target

          [Service]
          WorkingDirectory={{ mc_dir }}
          User={{ mc_user }}
          Group={{ mc_user }}
          Restart=always
          ExecStart=/usr/bin/java -Xmx{{ mc_jvm_heap }} {{ mc_jvm_flags }} -jar server.jar nogui

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Enable and start minecraft service
      systemd:
        name: "{{ mc_service_name }}"
        enabled: true
        state: started

  handlers:
    - name: Restart sshd
      service:
        name: "{{ 'ssh' if ansible_os_family == 'Debian' else 'sshd' }}"
        state: restarted
