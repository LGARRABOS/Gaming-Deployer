- name: Ensure unzip is installed (for modpack extraction)
  apt:
    name: unzip
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Download modpack server pack archive
  get_url:
    url: "{{ mc_modpack_url }}"
    dest: "{{ mc_dir }}/modpack-server-pack.zip"
    mode: "0644"
  when: mc_modpack_url is defined

- name: Extract modpack server pack archive
  unarchive:
    src: "{{ mc_dir }}/modpack-server-pack.zip"
    dest: "{{ mc_dir }}"
    remote_src: true
  when: mc_modpack_url is defined

- name: Ensure modpack files are owned by mc_user
  file:
    path: "{{ mc_dir }}"
    owner: "{{ mc_user }}"
    group: "{{ mc_user }}"
    recurse: true
  when: mc_modpack_url is defined

- name: Ensure server.properties uses deployment settings (modpack)
  lineinfile:
    path: "{{ mc_dir }}/server.properties"
    create: true
    owner: "{{ mc_user }}"
    group: "{{ mc_user }}"
    mode: "0644"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^server-port=', line: "server-port={{ mc_port }}" }
    - { regexp: '^motd=', line: "motd={{ mc_motd }}" }
    - { regexp: '^max-players=', line: "max-players={{ mc_max_players }}" }
    - { regexp: '^online-mode=', line: "online-mode={{ 'true' if mc_online_mode else 'false' }}" }
  when: mc_modpack_url is defined

- name: Check launch scripts (run.sh / start.sh / startserver.sh)
  stat:
    path: "{{ item }}"
  loop:
    - "{{ mc_dir }}/run.sh"
    - "{{ mc_dir }}/start.sh"
    - "{{ mc_dir }}/startserver.sh"
  register: mc_launch_scripts
  when: mc_modpack_url is defined

- name: Make launch scripts executable
  file:
    path: "{{ item }}"
    mode: "0755"
  loop:
    - "{{ mc_dir }}/run.sh"
    - "{{ mc_dir }}/start.sh"
    - "{{ mc_dir }}/startserver.sh"
  when: mc_modpack_url is defined

- name: Check if server.jar exists (Mojang jar)
  stat:
    path: "{{ mc_dir }}/server.jar"
  register: mc_server_jar
  when: mc_modpack_url is defined

- name: Download vanilla server jar when missing (required by some server packs)
  get_url:
    url: "{{ mc_server_jar_url }}"
    dest: "{{ mc_dir }}/server.jar"
    mode: "0644"
  when: mc_modpack_url is defined and (mc_server_jar.stat.exists is not defined or not mc_server_jar.stat.exists) and mc_server_jar_url is defined

- name: Set ownership of downloaded server.jar
  file:
    path: "{{ mc_dir }}/server.jar"
    owner: "{{ mc_user }}"
    group: "{{ mc_user }}"
  when: mc_modpack_url is defined and mc_server_jar_url is defined
