- name: Ensure unzip is installed (for modpack extraction)
  apt:
    name: unzip
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Download modpack server pack archive
  get_url:
    url: "{{ mc_modpack_url }}"
    dest: "{{ mc_dir }}/modpack-server-pack.zip"
    mode: "0644"
  when: mc_modpack_url is defined

- name: Extract modpack server pack archive
  unarchive:
    src: "{{ mc_dir }}/modpack-server-pack.zip"
    dest: "{{ mc_dir }}"
    remote_src: true
  when: mc_modpack_url is defined

- name: Ensure modpack files are owned by mc_user
  file:
    path: "{{ mc_dir }}"
    owner: "{{ mc_user }}"
    group: "{{ mc_user }}"
    recurse: true
  when: mc_modpack_url is defined

- name: Check client-pack markers (manifest.json / overrides)
  stat:
    path: "{{ item }}"
  loop:
    - "{{ mc_dir }}/manifest.json"
    - "{{ mc_dir }}/overrides"
  register: mc_client_pack_markers
  when: mc_modpack_url is defined

- name: Ensure server.properties uses deployment settings (modpack)
  lineinfile:
    path: "{{ mc_dir }}/server.properties"
    create: true
    owner: "{{ mc_user }}"
    group: "{{ mc_user }}"
    mode: "0644"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^server-port=', line: "server-port={{ mc_port }}" }
    - { regexp: '^motd=', line: "motd={{ mc_motd }}" }
    - { regexp: '^max-players=', line: "max-players={{ mc_max_players }}" }
    - { regexp: '^online-mode=', line: "online-mode={{ 'true' if mc_online_mode else 'false' }}" }
  when: mc_modpack_url is defined

- name: Relax ServerPackCreator Java check (disable Jabba, utiliser Java système)
  lineinfile:
    path: "{{ mc_dir }}/variables.txt"
    regexp: '^SKIP_JAVA_CHECK\s*='
    line: "SKIP_JAVA_CHECK=true"
    create: false
  when: mc_modpack_url is defined

- name: Disable interactive wait on script end (ServerPackCreator)
  lineinfile:
    path: "{{ mc_dir }}/variables.txt"
    regexp: '^WAIT_FOR_USER_INPUT\s*='
    line: "WAIT_FOR_USER_INPUT=false"
    create: false
  when: mc_modpack_url is defined

- name: Disable script-level restart loop (use systemd instead)
  lineinfile:
    path: "{{ mc_dir }}/variables.txt"
    regexp: '^RESTART\s*='
    line: "RESTART=false"
    create: false
  when: mc_modpack_url is defined

- name: Check launch scripts (run.sh / start.sh / startserver.sh)
  stat:
    path: "{{ item }}"
  loop:
    - "{{ mc_dir }}/run.sh"
    - "{{ mc_dir }}/start.sh"
    - "{{ mc_dir }}/startserver.sh"
  register: mc_launch_scripts
  when: mc_modpack_url is defined

- name: Make launch scripts executable
  file:
    path: "{{ item.stat.path }}"
    mode: "0755"
  loop: "{{ mc_launch_scripts.results | default([]) }}"
  when: mc_modpack_url is defined and (item.stat.exists | default(false))

- name: Check if server.jar exists (Mojang jar)
  stat:
    path: "{{ mc_dir }}/server.jar"
  register: mc_server_jar
  when: mc_modpack_url is defined

- name: Fail early if modpack looks like a client pack (manifest.json + overrides, aucun serveur présent)
  fail:
    msg: "Le ZIP fourni ressemble à un modpack client (manifest.json + overrides) et ne contient pas de serveur (start.sh / startserver.sh / run.sh / server.jar). Utilise un server pack CurseForge."
  when:
    - mc_modpack_url is defined
    - mc_client_pack_markers is defined
    - (mc_client_pack_markers.results[0].stat.exists | default(false))
    - (mc_client_pack_markers.results[1].stat.exists | default(false))
    - (mc_server_jar is not defined or not (mc_server_jar.stat.exists | default(false)))
    - (mc_launch_scripts is not defined or (
        not (mc_launch_scripts.results[0].stat.exists | default(false)) and
        not (mc_launch_scripts.results[1].stat.exists | default(false)) and
        not (mc_launch_scripts.results[2].stat.exists | default(false))
      ))

- name: Download vanilla server jar when missing (required by some server packs)
  get_url:
    url: "{{ mc_server_jar_url }}"
    dest: "{{ mc_dir }}/server.jar"
    mode: "0644"
  when: mc_modpack_url is defined and (mc_server_jar.stat.exists is not defined or not mc_server_jar.stat.exists) and mc_server_jar_url is defined

- name: Set ownership of downloaded server.jar
  file:
    path: "{{ mc_dir }}/server.jar"
    owner: "{{ mc_user }}"
    group: "{{ mc_user }}"
  when: mc_modpack_url is defined and mc_server_jar_url is defined
