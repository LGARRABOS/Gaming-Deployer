#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_REPO_DIR="/opt/proxmox-game-deployer"

# Detect repository directory:
# 1) If the script lives inside the repo (scripts/pgdctl), use its parent.
# 2) Else, if /opt/proxmox-game-deployer is a git repo, use that.
# 3) Else, fallback to current working directory.
if [[ -d "$SCRIPT_DIR/../.git" ]]; then
  REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
elif [[ -d "$DEFAULT_REPO_DIR/.git" ]]; then
  REPO_DIR="$DEFAULT_REPO_DIR"
else
  REPO_DIR="$(pwd)"
fi

SERVICE_NAME="game-deployer.service"
UPDATE_SERVICE_NAME="game-deployer-update.service"

usage() {
  cat <<EOF
pgdctl - Proxmox Game Deployer control script

Usage:
  pgdctl update      # pull + build + restart (manual, verbose)
  pgdctl status      # show main service status
  pgdctl restart     # restart main service
  pgdctl logs        # tail main service logs

Tips:
  Run with sudo when required, e.g.:
    sudo $0 update
EOF
}

cmd="${1:-help}"

case "$cmd" in
  update)
    echo "==> Proxmox Game Deployer - manual update"
    echo "Repository: $REPO_DIR"
    echo ""

    cd "$REPO_DIR"

    echo "[1/4] Checking for updates (origin/main)..."
    git fetch origin main
    LOCAL="$(git rev-parse HEAD)"
    REMOTE="$(git rev-parse origin/main)"
    if [[ "$LOCAL" == "$REMOTE" ]]; then
      echo ""
      echo "==> No update available (already up to date with origin/main)."
      exit 0
    fi
    git reset --hard origin/main
    echo "    Git repository updated."
    echo ""

    echo "[2/4] Building frontend..."
    cd "$REPO_DIR/frontend"
    npm install --omit=dev=false
    npm run build
    echo "    Frontend build completed."
    echo ""

    echo "[3/4] Building backend..."
    cd "$REPO_DIR/backend"
    go build -o /usr/local/bin/proxmox-game-deployer ./cmd/server
    echo "    Backend build completed."
    echo ""

    echo "[4/4] Restarting systemd service: $SERVICE_NAME"
    systemctl restart "$SERVICE_NAME"
    systemctl is-active "$SERVICE_NAME" >/dev/null 2>&1 || {
      echo "!! Service $SERVICE_NAME is not active after restart."
      systemctl status "$SERVICE_NAME" --no-pager || true
      exit 1
    }
    echo "    Service restarted successfully."
    echo ""
    echo "==> Update completed successfully."
    ;;
  status)
    systemctl status "$SERVICE_NAME" --no-pager
    ;;
  restart)
    echo "[pgdctl] Restarting $SERVICE_NAME..."
    systemctl restart "$SERVICE_NAME"
    systemctl status "$SERVICE_NAME" --no-pager
    ;;
  logs)
    echo "[pgdctl] Tailing logs for $SERVICE_NAME (Ctrl+C to stop)..."
    journalctl -u "$SERVICE_NAME" -n 50 -f
    ;;
  help|--help|-h)
    usage
    ;;
  *)
    echo "Unknown command: $cmd"
    usage
    exit 1
    ;;
esac

